package com.childproduct.designassistant.ai

import com.childproduct.designassistant.model.EnhancedProductType
import com.childproduct.designassistant.model.InternationalStandard

/**
 * Prompt模板管理器
 * 确保生成准确的技术输出
 */
object PromptTemplate {

    /**
     * 系统提示词 - 角色定义
     */
    private val SYSTEM_PROMPT = """
# 角色定义
你是儿童产品设计专家助手，专注于儿童安全座椅、婴儿推车、高脚椅、婴儿床等产品的技术标准和设计规范。你具备深厚的行业知识，熟悉全球主要标准（ECE R129、FMVSS 213、GB 27887等）。

# 任务目标
为工程师提供准确、专业的产品设计建议，确保符合所选标准的技术要求。

# 核心原则（最高优先级）
1. **标准隔离原则（绝对禁止违反）**
   - ⛔ 严格只输出用户选择的标准内容
   - ⛔ 禁止混用其他标准（即使用户未选择的标准更熟悉）
   - ⛔ 输出时必须明确标注："本建议基于标准：[标准代码]"
   - ⛔ 如果用户选择ECE R129，绝对不能输出FMVSS 213的内容
   - ⛔ 如果用户选择FMVSS 213，绝对不能输出ECE R129的内容

2. **参数匹配原则（必须严格遵守）**
   - ✅ 假人匹配必须严格基于输入的身高范围
   - ✅ 年龄计算必须基于身高范围，不能任意修改
   - ✅ 身高范围输出必须与输入完全一致，不能缩小或扩大
   - ✅ 约束阈值必须使用所选标准的要求，不能混用其他标准

3. **准确性优先**
   - 所有技术参数必须精确到具体条款和数值
   - 必须标注参数来源的具体条款编号
   - 禁止猜测或编造数据

4. **可操作性**
   - 提供具体的代码示例和实施方案
   - 说明验证方法和测试流程

5. **风险提示**
   - 明确指出潜在的设计风险
   - 提供风险缓解措施

# 假人匹配规则（儿童安全座椅专用）
- **40-75cm**：Q0假人（新生儿-9个月）
- **60-105cm**：Q1假人（9个月-3岁）
- **76-105cm**：Q1.5假人（1.5岁-4岁）
- **100-150cm**：Q3假人（3岁-12岁）
- **美标专用**：Q3s假人（3岁，仅FMVSS 213）

⚠️ 重要提醒：
- 如果输入是40-105cm，必须匹配Q0、Q1、Q1.5（覆盖0-4岁）
- 如果输入是100-150cm，只匹配Q3（覆盖3-12岁）
- 禁止随意缩小或扩大输入的身高范围

# 约束阈值标准
- **ECE R129 / GB 27887-2024**：
  - HIC ≤ 1000
  - 侧面碰撞胸部压缩量 ≤ 44mm
  - 头部加速度 ≤ 60g
  
- **FMVSS 213**：
  - HIC ≤ 1000
  - 侧面碰撞胸部压缩量 ≤ 23mm
  - 织带强度 ≥ 11000N

# 能力
- 标准解读与条款查询
- 设计参数计算与验证
- 测试方案制定
- 材料规格建议
- 问题诊断与优化建议
    """.trimIndent()

    /**
     * 生成设计建议的Prompt
     */
    fun generateDesignAdvicePrompt(
        productType: EnhancedProductType,
        standards: List<InternationalStandard>,
        heightRange: String? = null,
        customRequest: String? = null
    ): String {
        val standardList = standards.joinToString("、") { "${it.displayName}(${it.code})" }
        val standardCodes = standards.joinToString("、") { it.code }
        
        return """
## 设计需求分析

### 产品信息
- 产品类型：${productType.displayName}
- 适配标准：$standardList

### 输入参数
${heightRange?.let { "- 身高范围：$it cm（必须严格遵守，输出时不得修改）" } ?: "- 身高范围：未指定"}
${customRequest?.let { "- 特殊需求：$it" } ?: "- 特殊需求：无"}

### ⚠️ 重要约束（必须遵守）
1. **标准隔离（绝对禁止违反）**
   - 本建议仅基于标准：$standardCodes
   - 禁止输出其他标准的内容（即使用户未选择的标准）
   - 禁止混用不同标准的技术参数

2. **身高范围（必须与输入完全一致）**
   ${if (heightRange != null) "- 输入身高范围：$heightRange cm\n- 输出标注的身高范围必须与输入完全一致\n- 禁止缩小或扩大身高范围" else "- 未指定身高范围，输出时请标注'全年龄段'或'未指定'"}

3. **假人匹配规则（儿童安全座椅专用）**
   - 必须严格基于输入的身高范围匹配假人
   - 40-75cm → Q0假人（新生儿-9个月）
   - 60-105cm → Q1假人（9个月-3岁）
   - 76-105cm → Q1.5假人（1.5岁-4岁）
   - 100-150cm → Q3假人（3岁-12岁）
   - Q3s假人仅用于FMVSS 213（美标）

4. **约束阈值规则**
   - 必须使用所选标准的约束阈值
   - 禁止混用其他标准的阈值
   - 必须标注参数来源的具体条款编号

### 任务要求
请基于以上信息，提供以下设计建议：

1. **标准合规性分析**
   - 列出所选标准的核心要求
   - 识别关键技术参数
   - 指出必须遵守的强制性条款

2. **设计参数建议**
   - 提供关键设计尺寸范围
   - 给出材料规格建议
   - 说明安全阈值要求

3. **测试方案**
   - 列出必要的测试项目
   - 说明测试方法和通过标准
   - 提供测试矩阵

4. **风险提示**
   - 识别潜在的设计风险
   - 提供风险缓解措施
   - 说明常见错误及避免方法

## 输出格式要求

请使用以下格式输出，确保清晰易读：

## 【标准合规性分析】
### 基于标准：$standardCodes
#### 核心要求
- 要求1：[具体描述] (条款：[标准条款编号])
- 要求2：[具体描述] (条款：[标准条款编号])

#### 约束阈值
- HIC：[数值] (条款：[条款编号])
- 其他关键参数：[数值] (条款：[条款编号])

## 【设计参数建议】

### 身高范围
- 输入范围：${heightRange ?: "未指定"} cm
- 适配年龄：[基于身高范围计算的年龄]

### 假人匹配
- 匹配的假人类型：[根据身高范围匹配的假人]
- 假人数量：[数量]个
- 假人规格：
  - 假人1：[类型] - [身高范围] - [年龄范围] (标准：[$standardCodes])
  - 假人2：[类型] - [身高范围] - [年龄范围] (标准：[$standardCodes])

### 关键尺寸
- 尺寸1：[数值] ± [公差] (条款：[标准条款编号])
- 尺寸2：[数值] ± [公差] (条款：[标准条款编号])

### 材料规格
- 组件1：[材料规格] (标准：[$standardCodes] / 测试标准：[测试标准])
- 组件2：[材料规格] (标准：[$standardCodes] / 测试标准：[测试标准])

⚠️ 材料测试标准必须与所选标准体系一致：
- ECE/国标 → 使用GB/T或ISO标准
- 美标 → 使用ASTM或SAE标准

## 【测试方案】
| 测试项目 | 测试方法 | 通过标准 | 标准条款 |
|----------|----------|----------|----------|
| [项目1] | [方法] | [标准] | [条款] |
| [项目2] | [方法] | [标准] | [条款] |

## 【风险提示】
### 高风险项
- 风险1：[描述] → 缓解措施：[措施]
- 风险2：[描述] → 缓解措施：[措施]

### 常见错误
1. 混用不同标准的参数 → 正确做法：严格使用所选标准
2. 修改输入的身高范围 → 正确做法：保持与输入完全一致
3. 假人匹配错误 → 正确做法：严格按照身高范围匹配

### 标准合规检查
- ✅ 所有参数均基于标准：$standardCodes
- ✅ 身高范围与输入一致：${heightRange ?: "未指定"} cm
- ✅ 假人匹配正确：[勾选]
- ✅ 约束阈值符合标准：[勾选]

⚠️ **重要提示**：
- 本建议仅基于用户选择的标准：$standardCodes
- 请勿引用其他标准（如ECE R129、FMVSS 213等，除非用户已选择）
- 所有参数必须标注来源标准的具体条款
- 身高范围输出必须与输入完全一致，不得修改
- 材料测试标准必须与所选标准体系一致
        """.trimIndent()
    }

    /**
     * 生成标准查询的Prompt
     */
    fun generateStandardQueryPrompt(
        standardCode: String,
        queryType: String,
        keywords: List<String>
    ): String {
        return """
## 标准查询

### 查询参数
- 标准代码：$standardCode
- 查询类型：$queryType
- 关键词：${keywords.joinToString("、")}

### ⚠️ 重要约束（必须遵守）
1. **标准隔离（绝对禁止违反）**
   - 仅提供标准：$standardCode 的内容
   - 禁止引用其他标准（如ECE R129、FMVSS 213、GB 27887等）
   - 如果查询的关键词在标准中不存在，必须明确说明"该标准中未找到相关内容"

2. **准确性要求**
   - 所有条款必须提供准确的条款编号
   - 所有数值必须标注单位和测试条件
   - 禁止猜测或编造条款内容

### 任务要求
请查询标准 $standardCode 中与「${keywords.joinToString("、")}」相关的所有条款，并提供以下信息：

1. **相关条款列表**
   - 条款编号
   - 条款内容
   - 适用范围

2. **技术参数提取**
   - 提取所有数值要求（尺寸、重量、时间等）
   - 说明测试条件
   - 标注单位

3. **实施指南**
   - 如何在实际设计中应用
   - 常见错误及避免方法
   - 验证方法

## 输出格式

## 【条款查询结果】

### 标准概述
- 标准全称：[标准全称]
- 标准代码：$standardCode
- 最新版本：[版本号]
- 发布日期：[日期]

### 相关条款
#### 条款1：[条款编号]
**内容**：[条款原文]
**适用范围**：[范围]
**技术参数**：
- 参数1：[数值] [单位] (条件：[条件])
- 参数2：[数值] [单位] (条件：[条件])

#### 条款2：[条款编号]
...

### 技术参数汇总
| 参数名称 | 要求值 | 单位 | 测试条件 | 条款来源 |
|----------|--------|------|----------|----------|
| [参数1] | [值] | [单位] | [条件] | $standardCode [条款] |
| [参数2] | [值] | [单位] | [条件] | $standardCode [条款] |

### 实施指南
1. [步骤1]
2. [步骤2]

### 常见错误
1. [错误1] → [正确做法]
2. [错误2] → [正确做法]

### 标准合规检查
- ✅ 所有条款均来自标准：$standardCode
- ✅ 未引用其他标准的内容
- ✅ 所有参数均有明确的条款来源

⚠️ **注意事项**：
- 仅提供 $standardCode 标准的内容
- 不要混用其他标准（如ECE R129、FMVSS 213、GB 27887等）
- 如果查询的关键词在标准中不存在，明确说明"在标准 $standardCode 中未找到与「${keywords.joinToString("、")}」相关的内容"
- 禁止猜测或编造条款
        """.trimIndent()
    }

    /**
     * 生成问题诊断的Prompt
     */
    fun generateProblemDiagnosisPrompt(
        problemDescription: String,
        context: String? = null,
        productType: EnhancedProductType? = null,
        standards: List<InternationalStandard>? = null
    ): String {
        val standardContext = standards?.joinToString("、") { "${it.displayName}(${it.code})" } ?: "无指定标准"
        val productContext = productType?.displayName ?: "通用产品"
        val standardCodes = standards?.joinToString("、") { it.code } ?: "无"

        return """
## 问题诊断分析

### 问题描述
$problemDescription

### 上下文信息
- 产品类型：$productContext
- 适用标准：$standardContext
${context?.let { "- 附加信息：$it" } ?: ""}

### ⚠️ 重要约束（必须遵守）
${if (standards?.isNotEmpty() == true) """
1. **标准隔离（绝对禁止违反）**
   - 本诊断仅基于标准：$standardCodes
   - 禁止引用其他标准的内容
   - 禁止使用其他标准的参数或要求
   
2. **标准合规检查**
   - 必须基于标准 $standardCodes 检查问题
   - 必须引用具体的条款编号
   - 必须说明违反的标准要求
""" else """
1. **通用技术诊断**
   - 未指定具体标准，提供通用技术建议
   - 如果涉及标准合规性，请明确标注"未指定标准，仅供参考"
   - 建议用户指定相关标准以获得更准确的诊断
"""}

### 任务要求
请对以上问题进行深入分析，并提供诊断报告：

1. **问题定位**
   - 识别问题的根本原因
   - 分析问题影响范围
   - 判断严重程度

2. **根因分析**
   - 从技术角度分析原因
   - 识别设计缺陷
   - 识别流程问题

3. **解决方案**
   - 提供具体修复方案
   - 给出代码示例（如适用）
   - 说明验证方法

4. **预防措施**
   - 如何避免类似问题
   - 建议的改进措施
   - 长期优化方向

## 输出格式

## 【问题诊断报告】

### 1. 问题概述
- **问题描述**：[简明描述]
- **严重程度**：[高/中/低]
- **影响范围**：[描述]
- **基于标准**：$standardContext

### 2. 问题定位
#### 根本原因
[详细分析]

#### 影响分析
- 直接影响：[描述]
- 间接影响：[描述]

### 3. 根因分析
#### 技术原因
- 原因1：[描述]
- 原因2：[描述]

#### 设计原因
- 原因1：[描述]
- 原因2：[描述]

${if (standards?.isNotEmpty() == true) {
"""
#### 标准合规性
- 基于标准：$standardCodes
- 是否符合标准：[是/否]
- 违反的条款（如有）：
  - 条款 [编号]：[违规内容] → [正确要求]
  - 条款 [编号]：[违规内容] → [正确要求]

#### 常见标准违反问题
1. 混用不同标准的参数 → 正确做法：严格使用所选标准
2. 参数值不满足标准要求 → 正确做法：对照标准条款调整
3. 测试方法不符合标准 → 正确做法：使用标准规定的测试方法
"""
} else """
#### 通用技术检查
- 未指定标准，以下为通用建议
- 建议指定相关标准以获得更准确的诊断
"""}

### 4. 解决方案
#### 修复方案
**方案1**：[描述]
- 实施步骤：
  1. [步骤1]
  2. [步骤2]
- 预期效果：[描述]
- 验证方法：[方法]
${if (standards?.isNotEmpty() == true) "- 符合标准条款：[条款编号]" else ""}

**方案2**：[描述]（如有）

#### 代码示例（如适用）
```kotlin
// 代码示例
```

### 5. 预防措施
1. [措施1]
2. [措施2]
${if (standards?.isNotEmpty() == true) "3. 定期对照标准 $standardCodes 进行合规性检查" else ""}

### 6. 长期优化
- [优化建议1]
- [优化建议2]

### 7. 标准合规检查
${if (standards?.isNotEmpty() == true) """
- ✅ 所有诊断基于标准：$standardCodes
- ✅ 未引用其他标准的内容
- ✅ 所有条款均有明确的来源
""" else """
⚠️ 未指定标准，本诊断为通用技术建议
💡 建议指定相关标准以获得更准确的诊断
"""}

⚠️ **注意事项**：
${if (standards?.isNotEmpty() == true) """
- 本诊断仅基于用户选择的标准：$standardCodes
- 请勿引用其他标准的内容
- 所有解决方案必须符合所选标准的要求
- 如果问题违反了标准，必须明确指出违反的具体条款
""" else """
- 未指定标准，仅提供通用技术建议
- 如需更精确的诊断，请提供具体的标准信息
- 建议咨询相关领域的标准专家
"""}

${if (standards?.isNotEmpty() == true) """
### 标准参考
- 标准代码：$standardCodes
- 相关条款：[列出相关条款编号]
""" else ""}
        """.trimIndent()
    }

    /**
     * 生成通用聊天的Prompt
     */
    fun generateChatPrompt(
        message: String,
        context: String? = null
    ): String {
        return """
## 对话

${context?.let { "上下文信息：\n$context\n\n" } ?: ""}
用户消息：$message

请友好、专业地回应用户，提供有帮助的信息。
        """.trimIndent()
    }

    /**
     * 获取系统提示词
     */
    fun getSystemPrompt(): String {
        return SYSTEM_PROMPT
    }
}
