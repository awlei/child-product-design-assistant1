# ECE R129r4e 标准数据修正报告

## 修正日期
2024年

## 修正概述
根据联合国法规 No.129（R129r4e）最新版本（2020年9月24日生效）对儿童约束系统标准数据进行了全面修正。

## 修正文件列表

### 1. StandardsData.kt
**文件路径**: `app/src/main/java/com/childproduct/designassistant/data/StandardsData.kt`

#### 修正内容：

##### 1.1 正面撞击测试标准条款更新
- **原值**: `§6.2`，ECE R129:2013
- **新值**: `§6.6.4.3.1`，ECE R129 Rev.4
- **修正理由**: 使用最新的条款编号和标准版本

##### 1.2 测试合格标准修正
**修正前**:
```
合格标准：头部位移＜25cm；HIC＜700；胸部加速度＜55g
```

**修正后**:
```
合格标准：头部位移符合平面限制；HPC≤600(Q0,Q1,Q1.5,Q3)或≤800(Q6,Q10)；
头部加速度3ms≤75g(Q0,Q1,Q1.5,Q3)或≤80g(Q6,Q10)；
胸部加速度3ms≤55g；
腹部压力≤1.2bar(Q1.5,Q10)或≤1.0bar(Q3,Q6)
```

**依据**: R129r4e §6.6.4.3.1 - Table 4

##### 1.3 产品分类条款更新
- **原值**: `§4.2.2` - Forward facing – Class B1：适用于身高100-105cm
- **新值**: `§6.1.2.7` - 年龄和身高限制要求
- **修正内容**:
  - 15个月以下儿童必须使用后向或侧向儿童约束系统
  - 后向座椅应能容纳身高至83cm的儿童
  - 前向座椅不应设计用于容纳身高低于76cm的儿童
  - 可转换座椅在其后向配置下应能容纳身高至83cm的儿童
  - 非整体式儿童约束系统不得批准低于100cm的身高
  - 非整体式儿童约束系统上限不能低于105cm
  - 增高座椅头部保护应覆盖至135cm

##### 1.4 标准匹配逻辑修正
**修正后的匹配逻辑**:
- 40-83cm: 后向安装 / i-Size（新生儿-15个月）
- 76-105cm: 前向安装 / i-Size（15个月-4岁）
- 100cm+: 非整体式 / i-Size booster seat（4岁-12岁）

##### 1.5 测试用例细化
将原来的单一测试用例拆分为3个测试用例，对应不同的假人类型和合格标准：
- Q0, Q1, Q1.5: HPC≤600, 头部加速度≤75g
- Q3: HPC≤800, 头部加速度≤80g, 腹部压力≤1.0bar
- Q6, Q10: HPC≤800, 头部加速度≤80g, 腹部压力≤1.0bar(Q6), 1.2bar(Q10)

---

### 2. HeightAgeGroupMapping.kt
**文件路径**: `app/src/main/java/com/childproduct/designassistant/data/HeightAgeGroupMapping.kt`

#### 修正内容：

##### 2.1 ECEGroup枚举更新
**新增字段**:
```kotlin
val isRearwardRequired: Boolean  // 是否必须后向
```

**修正后的分组**:
```kotlin
GROUP_0_PLUS(
    code = "Group 0+",
    displayName = "Group 0+ / i-Size",
    weightRange = "0-13kg",
    heightRange = "40-83cm",  // 从40-75cm修正为40-83cm
    ageRange = "新生儿-15个月",  // 从新生儿-12个月修正为新生儿-15个月
    isRearwardRequired = true
)
```

##### 2.2 身高阈值常量定义
**新增常量**:
```kotlin
const val MAX_REARWARD_HEIGHT = 83.0      // 后向座椅最大83cm（15个月）
const val MIN_FORWARD_HEIGHT = 76.0      // 前向座椅最小76cm（15个月）
const val MIN_BOOSTER_HEIGHT = 100.0     // 非整体式座椅最小100cm
const val MIN_BOOSTER_UPPER_LIMIT = 105.0 // 非整体式座椅最小上限105cm
const val BOOSTER_HEAD_PROTECTION = 135.0 // 增高座椅头部保护至135cm
```

##### 2.3 matchSafetySeatHeight方法修正
**修正前**:
- 基于75cm阈值进行分组判断

**修正后**:
- 基于R129r4e关键阈值（83cm、76cm、100cm、105cm）进行分组判断
- 添加对15个月以下必须后向的逻辑判断
- 考虑非整体式座椅的特殊要求

##### 2.4 新增determineRecommendedDirectionR129方法
**方法功能**: 基于R129r4e §6.1.2.7确定推荐朝向

**逻辑**:
```kotlin
when {
    // 15个月以下（身高≤83cm）必须后向
    maxHeight <= MAX_REARWARD_HEIGHT -> "后向（R129r4e强制要求）"
    // 跨越15个月界限
    minHeight <= MAX_REARWARD_HEIGHT && maxHeight >= MIN_FORWARD_HEIGHT -> 
        "后向（≤15个月/≤83cm）→ 前向（≥15个月/≥76cm）"
    // 15个月以上
    minHeight >= MIN_FORWARD_HEIGHT -> "前向"
    else -> "前向"
}
```

---

### 3. EceR129StandardDatabase.kt
**文件路径**: `app/src/main/java/com/childproduct/designassistant/data/EceR129StandardDatabase.kt`

#### 修正内容：

##### 3.1 测试矩阵数据修正
**修正前**:
```
acceptanceCriteria = "HIC36 ≤ 324，胸部加速度 ≤ 55g"
```

**修正后**:
```
// Q0（新生儿，≤60cm）
acceptanceCriteria = "HPC≤600，头部加速度3ms≤75g，胸部加速度3ms≤55g"

// Q1.5（18个月，75-87cm）
acceptanceCriteria = "HPC≤600，头部加速度3ms≤75g，胸部加速度3ms≤55g，腹部压力≤1.2bar"

// Q3（3岁，87-105cm）
acceptanceCriteria = "HPC≤800，头部加速度3ms≤80g，胸部加速度3ms≤55g，腹部压力≤1.0bar"

// Q6（6岁，105-125cm）
acceptanceCriteria = "HPC≤800，头部加速度3ms≤80g，胸部加速度3ms≤55g，腹部压力≤1.0bar"

// Q10（10岁，125-150cm）
acceptanceCriteria = "HPC≤800，头部加速度3ms≤80g，胸部加速度3ms≤55g，腹部压力≤1.2bar"
```

##### 3.2 标准条款号更新
**修正前**:
```
standardClause = "ECE R129 §5.3.2"
```

**修正后**:
```
standardClause = "ECE R129 Rev.4 §7.1.3, §6.6.4.3.1"
```

##### 3.3 测试条件修正
**修正前**:
```
testMethod = "50km/h 正面撞击刚性障碍物，ISOFIX 3点，带支撑腿"
```

**修正后**:
```
testMethod = "50km/h 正面撞击刚性障碍物，ΔV=52km/h，ISOFIX 3点，带支撑腿"
```

**依据**: R129r4e §7.1.3.1.1.5.2

##### 3.4 侧面碰撞测试修正
**修正前**:
```
testMethod = "50km/h 侧面撞击可变形障碍物，ISOFIX 3点"
```

**修正后**:
```
testMethod = "32km/h 侧面撞击可变形障碍物，门侵入深度，ISOFIX 3点"
acceptanceCriteria = "头部偏移量≤150mm，头部加速度3ms≤80g，头部无接触车门"
```

**依据**: R129r4e §7.1.3.1.3, §6.6.4.5.1

---

## 关键修正依据（R129r4e标准）

### §6.1.2.7 年龄和身高限制
1. **15个月以下儿童**: 必须使用后向或侧向儿童约束系统
2. **后向座椅**: 应能容纳身高至83cm的儿童
3. **前向座椅**: 不应设计用于容纳身高低于76cm的儿童
4. **可转换座椅**: 在其后向配置下应能容纳身高至83cm的儿童

### §6.1.3.3 非整体式儿童约束系统
1. **最小认证身高**: 不得低于100cm
2. **最小上限**: 不得批准上限为105cm或以下的身高
3. **头部保护**: 应确保头部保护直至身高135cm

### §6.6.4.3.1 伤害评估准则（Table 4）

| 准则 | 缩写 | 单位 | Q0 | Q1 | Q1.5 | Q3 | Q6 | Q10 |
|------|------|------|----|----|------|----|----|-----|
| 头部性能准则 | HPC | | 600 | 600 | 600 | 800 | 800 | 800 |
| 头部加速度3ms | A_head_Cum3ms | g | 75 | 75 | 75 | 80 | 80 | 80 |
| 胸部加速度3ms | A_chest_Cum3ms | g | 55 | 55 | 55 | 55 | 55 | 55 |
| 腹部压力 | P | Bar | NA | NA | 1.2 | 1.0 | 1.0 | 1.2 |

### §7.1.3 动态测试条件

#### 正面撞击
- **速度**: 50km/h (减速度 sled) 或 ΔV=52km/h (加速度 sled)
- **加速度**: 符合 Annex 7 Appendix 1 走廊

#### 后向撞击
- **速度**: 30km/h (减速度 sled) 或 ΔV=32km/h (加速度 sled)
- **加速度**: 符合 Annex 7 Appendix 2 走廊

#### 侧面撞击
- **相对速度**: 6.375-7.25 m/s (符合 Annex 7 Appendix 3 走廊)
- **门侵入深度**: 按照 Annex 6 Appendix 3

### Annex 8 假人规格（Table 8 - §7.1.3.6）

| 身高范围（cm） | ≤60 | 60<x≤75 | 75<x≤87 | 87<x≤105 | 105<x≤125 | >125 |
|----------------|-----|---------|---------|----------|-----------|------|
| 假人类型 | Q0 | Q1 | Q1.5 | Q3 | Q6 | Q10 |
| 设计年龄 | 0 | 1 | 1.5 | 3 | 6 | 10.5 |

---

## 影响范围

### 功能模块
1. **标准匹配服务**: 更新了标准匹配逻辑，现在基于R129r4e要求
2. **动态测试矩阵**: 测试用例和合格标准已更新
3. **产品配置**: 产品分类和配置要求已更新
4. **UI显示**: 测试矩阵显示数据已更新

### 数据一致性
所有修改的数据现在都符合R129r4e标准，确保了：
- 测试标准的准确性
- 分组定义的正确性
- 合格标准的合规性

---

## 验证建议

### 单元测试
建议添加以下单元测试：
1. 测试不同身高范围的标准匹配结果
2. 验证测试矩阵生成逻辑
3. 确认伤害评估准则的正确性

### 集成测试
建议进行以下集成测试：
1. 端到端的用户输入-标准匹配-测试矩阵生成流程
2. 验证UI显示的正确性
3. 检查与现有功能的兼容性

---

## 注意事项

### 向后兼容性
- 旧版本代码可能仍然引用旧的条款号（如§5.3.2）
- 需要检查所有引用点并更新

### 数据迁移
- 如果用户之前保存了基于旧标准的数据，可能需要数据迁移脚本
- 建议在更新版本号时进行数据库版本管理

### 用户文档
- 需要更新用户手册，说明标准变化
- 建议在UI中添加版本标识，明确使用R129r4e标准

---

## 附录：R129r4e关键变化总结

### 相比R129:2013的主要变化
1. **更严格的年龄限制**: 15个月以下必须后向
2. **更详细的伤害评估**: 增加了头部加速度3ms和腹部压力
3. **区分化合格标准**: 不同假人类型有不同的合格标准
4. **更精确的身高分组**: 重新定义了各分组身高范围
5. **非整体式座椅要求**: 明确了增高垫的最低认证要求

### 新增内容
1. 腹部压力评估（Q1.5、Q3、Q6、Q10）
2. 头部加速度3ms累积值评估
3. 非整体式座椅的头部保护要求（至135cm）
4. 支撑腿评估体积的具体要求（§6.3.5）

---

**修正完成日期**: 2024年
**修正人**: Coze Coding
**审核状态**: 待审核
