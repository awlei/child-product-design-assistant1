name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'debug'
        type: choice
        options:
          - 'debug'
          - 'release'
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17 with Android SDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          android-sdk: true
          android-sdk-license-accept: true
          android-sdk-build-tools-version: '34.0.0'
          android-sdk-platforms: 'android-34'

      - name: Accept additional Android licenses
        run: yes | sdkmanager --licenses || true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode keystore
        if: github.event.inputs.release_type == 'release'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --no-daemon

      - name: Build Release APK
        if: github.event.inputs.release_type == 'release'
        run: ./gradlew assembleRelease --stacktrace --no-daemon
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Rename APKs
        run: |
          VERSION=$(grep 'versionName' app/build.gradle | awk '{print $2}' | tr -d '"')
          BUILD_NUMBER=${{ github.run_number }}
          
          # Rename Debug APK
          mv app/build/outputs/apk/debug/app-debug.apk \
             app/build/outputs/apk/debug/child-product-design-assistant-debug-v${VERSION}-build${BUILD_NUMBER}.apk
          
          # Rename Release APK (if built)
          if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
            mv app/build/outputs/apk/release/app-release-unsigned.apk \
               app/build/outputs/apk/release/child-product-design-assistant-release-v${VERSION}-build${BUILD_NUMBER}.apk
          fi

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 90

      - name: Upload Release APK
        if: github.event.inputs.release_type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 90

      - name: Get version info
        id: version
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle | awk '{print $2}' | tr -d '"')
          VERSION_CODE=$(grep 'versionCode' app/build.gradle | awk '{print $2}')
          BUILD_NUMBER=${{ github.run_number }}
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "buildNumber=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "Full Version: v${VERSION_NAME}-build${BUILD_NUMBER}"

      - name: Create GitHub Release
        if: github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.versionName }}-build${{ steps.version.outputs.buildNumber }}
          name: Release v${{ steps.version.outputs.versionName }}
          body: |
            ## ðŸŽ‰ å„¿ç«¥äº§å“è®¾è®¡åŠ©æ‰‹ APK
            
            ### ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.versionName }}
            - **æž„å»ºå·**: ${{ steps.version.outputs.buildNumber }}
            - **æäº¤**: ${{ github.sha }}
            - **åˆ†æ”¯**: ${{ github.ref_name }}
            
            ### ðŸ“¥ ä¸‹è½½
            
            #### Debugç‰ˆæœ¬ï¼ˆæµ‹è¯•ç”¨ï¼‰
            - `child-product-design-assistant-debug-v${{ steps.version.outputs.versionName }}-build${{ steps.version.outputs.buildNumber }}.apk`
            - é€‚åˆæ—¥å¸¸å¼€å‘å’Œæµ‹è¯•
            - åŒ…å«è°ƒè¯•åŠŸèƒ½
            
            #### Releaseç‰ˆæœ¬ï¼ˆæ­£å¼å‘å¸ƒï¼‰
            - `child-product-design-assistant-release-v${{ steps.version.outputs.versionName }}-build${{ steps.version.outputs.buildNumber }}.apk`
            - ç»è¿‡ä¼˜åŒ–ï¼Œé€‚åˆæ­£å¼å‘å¸ƒ
            - å¦‚æžœæœªç­¾åï¼Œéœ€è¦è‡ªè¡Œç­¾åæˆ–å®‰è£…åˆ°æµ‹è¯•è®¾å¤‡
            
            ### ðŸ”§ åŠŸèƒ½ç‰¹æ€§
            - âœ… æ ‡å‡†éš”ç¦»æœºåˆ¶ï¼ˆé˜²æ­¢å‚æ•°æ··ç”¨ï¼‰
            - âœ… å‡äººæ˜ å°„ä¿®æ­£ï¼ˆ8ç§å‡äººç±»åž‹ï¼šQ0/Q0+/Q1/Q1.5/Q3/Q3s/Q6/Q10ï¼‰
            - âœ… ROADMATE 360æ ¼å¼æµ‹è¯•çŸ©é˜µï¼ˆ20åˆ—ï¼‰
            - âœ… è¾“å…¥åˆè§„æ€§éªŒè¯ï¼ˆ40-105cmå¼ºåˆ¶åŽå‘ï¼Œ105cm+å¼ºåˆ¶Top-tetherï¼‰
            - âœ… ISOFIX Envelopeå°ºå¯¸è¦æ±‚
            - âœ… æ ‡å‡†ç‰ˆæœ¬è¿½è¸ªå’Œç‰ˆæœ¬æ°´å°
            
            ### ðŸ“± ç³»ç»Ÿè¦æ±‚
            - Android 7.0 (API 24) åŠä»¥ä¸Š
            - ç›®æ ‡SDK: Android 14 (API 34)
            
            ### ðŸ“š ä½¿ç”¨è¯´æ˜Ž
            1. ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
            2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æºåº”ç”¨"æƒé™
            3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
            4. å®‰è£…å®ŒæˆåŽå³å¯ä½¿ç”¨
            
            ### ðŸ› é—®é¢˜åé¦ˆ
            å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨GitHubä¸Šæäº¤Issue
            
            ### ðŸ“„ è®¸å¯è¯
            æœ¬é¡¹ç›®éµå¾ªç›¸å…³å¼€æºè®¸å¯è¯
            
            ---
            **æž„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **è§¦å‘è€…**: ${{ github.actor }}
          
          files: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, 'beta')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## ðŸ“¦ æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åž‹ | æ–‡ä»¶å | å¤§å° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debug | $(basename app/build/outputs/apk/debug/*.apk) | $(du -h app/build/outputs/apk/debug/*.apk | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          if [ -d app/build/outputs/apk/release ]; then
            echo "| Release | $(basename app/build/outputs/apk/release/*.apk 2>/dev/null || echo "N/A") | $(du -h app/build/outputs/apk/release/*.apk 2>/dev/null | cut -f1 || echo "N/A") |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: v${{ steps.version.outputs.versionName }}-build${{ steps.version.outputs.buildNumber }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
