name: Build APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create Release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-licenses: true
          api-level: 34
          build-tools: 34.0.0
          cmake: 3.22.1
          ndk: 25.2.9519653
        # æ³¨æ„ï¼šå»ºè®®å°†æ¥æ›¿æ¢ä¸ºå®˜æ–¹æ–¹æ¡ˆ actions/setup-java with android-sdk: true
        # å‚è€ƒï¼šhttps://github.com/actions/setup-java#android-sdk

      - name: Skip cache (temporarily disabled for debugging)
        run: echo "Cache disabled for debugging"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          GRADLE_OPTS: "-Xmx4096m -XX:MaxMetaspaceSize=1024m"

      - name: Build Release APK
        run: ./gradlew clean assembleRelease --no-daemon
        env:
          GRADLE_OPTS: "-Xmx4096m -XX:MaxMetaspaceSize=1024m"
          # å¦‚éœ€ç­¾åRelease APKï¼Œè¯·æ·»åŠ ä»¥ä¸‹çŽ¯å¢ƒå˜é‡ï¼š
          # SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          # SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          # SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}
        # ç­¾åé…ç½®éœ€åœ¨ app/build.gradle ä¸­é…ç½® signingConfigs.release

      - name: Verify Debug APK
        run: |
          echo "=== Verifying Debug APK ==="
          aapt dump badging app/build/outputs/apk/debug/*.apk | head -5
          ls -lh app/build/outputs/apk/debug/*.apk

      - name: Verify Release APK
        run: |
          echo "=== Verifying Release APK ==="
          aapt dump badging app/build/outputs/apk/release/*.apk | head -5
          ls -lh app/build/outputs/apk/release/*.apk

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Get version info
        id: version
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle | awk '{print $2}' | tr -d '"')
          VERSION_CODE=$(grep 'versionCode' app/build.gradle | awk '{print $2}')
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME ($VERSION_CODE)"

      - name: Create GitHub Release
        if: github.event.inputs.release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.versionName }}-build${{ github.run_number }}
          name: Release v${{ steps.version.outputs.versionName }}
          body: |
            ## ðŸŽ‰ è‡ªåŠ¨å‘å¸ƒ
            
            ### ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.versionName }}
            - **æž„å»ºå·**: ${{ github.run_number }}
            - **æäº¤**: ${{ github.sha }}
            
            ### ðŸ“¥ ä¸‹è½½
            
            #### Debugç‰ˆæœ¬ï¼ˆæµ‹è¯•ç”¨ï¼‰
            - `app-debug-v${{ steps.version.outputs.versionName }}.apk`
            
            #### Releaseç‰ˆæœ¬ï¼ˆå‘å¸ƒç”¨ï¼‰
            - `app-release-v${{ steps.version.outputs.versionName }}.apk`
            
            ### ðŸ”§ åŠŸèƒ½ç‰¹æ€§
            - æ ‡å‡†éš”ç¦»æœºåˆ¶ï¼ˆé˜²æ­¢å‚æ•°æ··ç”¨ï¼‰
            - å‡äººæ˜ å°„ä¿®æ­£ï¼ˆ8ç§å‡äººç±»åž‹ï¼‰
            - ROADMATE 360æ ¼å¼æµ‹è¯•çŸ©é˜µ
            - è¾“å…¥åˆè§„æ€§éªŒè¯
            
            ### ðŸ“š ä½¿ç”¨è¯´æ˜Ž
            1. ä¸‹è½½APKæ–‡ä»¶
            2. åœ¨Androidè®¾å¤‡ä¸Šå®‰è£…
            3. å¼€å¯"æœªçŸ¥æ¥æºåº”ç”¨"æƒé™
            4. å®‰è£…å¹¶è¿è¡Œ
          
          files: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## ðŸ“¦ æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åž‹ | æ–‡ä»¶å | å¤§å° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debug | app-debug.apk | $(du -h app/build/outputs/apk/debug/*.apk | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | app-release-unsigned.apk | $(du -h app/build/outputs/apk/release/*.apk | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
