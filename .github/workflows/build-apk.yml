name: Build APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release:
        description: 'Create Release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17 with Android SDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          android-sdk: true
          android-sdk-license-accept: true
          android-sdk-build-tools-version: '34.0.0'
          android-sdk-platforms: 'android-34'

      - name: Accept additional Android licenses
        run: yes | sdkmanager --licenses || true

      # Temporarily disable Gradle cache to force rebuild and clear KSP cache
      # - name: Setup Gradle cache
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/.gradle/caches
      #       ~/.gradle/wrapper
      #       ~/.gradle/daemon
      #     key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}-v3
      #     restore-keys: |
      #       ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean build cache and KSP artifacts
        run: ./gradlew clean --no-daemon

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          GRADLE_OPTS: "-Xmx4096m -XX:MaxMetaspaceSize=1024m"

      - name: Verify Debug APK
        run: |
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "=== Verifying Debug APK ==="
            if command -v aapt &> /dev/null; then
              aapt dump badging app/build/outputs/apk/debug/app-debug.apk | head -5
            fi
            ls -lh app/build/outputs/apk/debug/app-debug.apk
          else
            echo "Debug APK not found"
            exit 1
          fi

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Verify Debug APK
        run: |
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "=== Verifying Debug APK ==="
            if command -v aapt &> /dev/null; then
              aapt dump badging app/build/outputs/apk/debug/app-debug.apk | head -5
            fi
            ls -lh app/build/outputs/apk/debug/app-debug.apk
          else
            echo "Debug APK not found"
            exit 1
          fi

      - name: Verify Release APK
        if: success()
        run: |
          if [ -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "=== Verifying Release APK ==="
            if command -v aapt &> /dev/null; then
              aapt dump badging app/build/outputs/apk/release/app-release-unsigned.apk | head -5
            fi
            ls -lh app/build/outputs/apk/release/app-release-unsigned.apk
          else
            echo "Release APK not found"
          fi

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
          retention-days: 30

      - name: Get version info
        id: version
        run: |
          VERSION_NAME=$(grep -E "^\s+versionName\s+\"" app/build.gradle | head -1 | awk -F'"' '{print $2}')
          VERSION_CODE=$(grep -E "^\s+versionCode\s+" app/build.gradle | head -1 | awk '{print $2}')
          echo "versionName=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "versionCode=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME ($VERSION_CODE)"

      - name: Create GitHub Release
        if: github.event.inputs.release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.versionName }}-build${{ github.run_number }}
          name: Release v${{ steps.version.outputs.versionName }}
          body: |
            ## ðŸŽ‰ è‡ªåŠ¨å‘å¸ƒ
            
            ### ðŸ“¦ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬**: ${{ steps.version.outputs.versionName }}
            - **æž„å»ºå·**: ${{ github.run_number }}
            - **æäº¤**: ${{ github.sha }}
            
            ### ðŸ“¥ ä¸‹è½½
            
            #### Debugç‰ˆæœ¬ï¼ˆæµ‹è¯•ç”¨ï¼‰
            - `app-debug-v${{ steps.version.outputs.versionName }}.apk`
            
            #### Releaseç‰ˆæœ¬ï¼ˆå‘å¸ƒç”¨ï¼‰
            - `app-release-v${{ steps.version.outputs.versionName }}.apk`
            
            ### ðŸ”§ åŠŸèƒ½ç‰¹æ€§
            - æ ‡å‡†éš”ç¦»æœºåˆ¶ï¼ˆé˜²æ­¢å‚æ•°æ··ç”¨ï¼‰
            - å‡äººæ˜ å°„ä¿®æ­£ï¼ˆ8ç§å‡äººç±»åž‹ï¼‰
            - ROADMATE 360æ ¼å¼æµ‹è¯•çŸ©é˜µ
            - è¾“å…¥åˆè§„æ€§éªŒè¯
            
            ### ðŸ“š ä½¿ç”¨è¯´æ˜Ž
            1. ä¸‹è½½APKæ–‡ä»¶
            2. åœ¨Androidè®¾å¤‡ä¸Šå®‰è£…
            3. å¼€å¯"æœªçŸ¥æ¥æºåº”ç”¨"æƒé™
            4. å®‰è£…å¹¶è¿è¡Œ
          
          files: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "## ðŸ“¦ æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **æž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ç±»åž‹ | æ–‡ä»¶å | å¤§å° |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Debug | app-debug.apk | $(du -h app/build/outputs/apk/debug/*.apk | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | app-release-unsigned.apk | $(du -h app/build/outputs/apk/release/*.apk | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
